<div id="page-invoice" class="page space-y-4">
    <h2 class="text-2xl font-black">Nouvelle Vente</h2>
    <div class="bg-white p-6 rounded-3xl border space-y-4 shadow-sm">
        <input type="text" id="c_name" placeholder="Nom du Client" class="input-f">
        
        <div class="flex gap-2">
            <select id="v_product" class="input-f flex-1"></select>
            <input type="number" id="v_qty" placeholder="Qté" class="input-f w-20" value="1">
        </div>
        
        <button onclick="addToCart()" class="w-full py-3 bg-slate-100 text-blue-600 rounded-xl font-bold text-sm border-2 border-dashed border-blue-200">
            + Ajouter au panier
        </button>

        <div id="cartList" class="space-y-2 border-t pt-4 min-h-[50px]">
            <p class="text-[10px] text-center text-slate-400">Le panier est vide</p>
        </div>

        <div class="flex justify-between items-center py-2 border-t">
            <span class="font-bold text-sm text-slate-500">Total Panier :</span>
            <span id="cartTotal" class="font-black text-xl text-blue-600">0</span>
        </div>

        <button onclick="processFinalSale()" id="btnFinalSale" class="btn-p w-full uppercase shadow-lg opacity-50 pointer-events-none">
            Valider la Vente (PDF & Cloud)
        </button>
    </div>
</div>

<script>
    let cart = [];

    // --- AJOUTER UN ARTICLE AU PANIER ---
    function addToCart() {
        const pId = document.getElementById('v_product').value;
        const qty = parseInt(document.getElementById('v_qty').value);
        const prod = db.inventory.find(p => p.id == pId);

        if(!prod || qty <= 0) return alert("Sélectionnez un produit");
        if(qty > prod.qty) return alert("Stock insuffisant !");

        // Vérifier si déjà dans le panier
        const existing = cart.find(item => item.id == pId);
        if(existing) {
            if(existing.qty + qty > prod.qty) return alert("Stock insuffisant !");
            existing.qty += qty;
            existing.subtotal = existing.qty * prod.price;
        } else {
            cart.push({
                id: prod.id,
                name: prod.name,
                price: prod.price,
                cost: prod.cost,
                qty: qty,
                subtotal: prod.price * qty
            });
        }
        renderCart();
    }

    // --- AFFICHER LE PANIER ---
    function renderCart() {
        const container = document.getElementById('cartList');
        const btn = document.getElementById('btnFinalSale');
        
        if(cart.length === 0) {
            container.innerHTML = '<p class="text-[10px] text-center text-slate-400">Le panier est vide</p>';
            btn.classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('cartTotal').innerText = "0";
            return;
        }

        btn.classList.remove('opacity-50', 'pointer-events-none');
        let total = 0;
        container.innerHTML = cart.map((item, index) => {
            total += item.subtotal;
            return `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl text-xs">
                    <div>
                        <span class="font-bold">${item.name}</span>
                        <span class="text-slate-400 text-[10px]"> (x${item.qty})</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black">${item.subtotal.toLocaleString()}</span>
                        <button onclick="removeFromCart(${index})" class="text-red-500"><i data-lucide="x-circle" class="w-4"></i></button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('cartTotal').innerText = total.toLocaleString();
        lucide.createIcons();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // --- VALIDER LA VENTE FINALE ---
    async function processFinalSale() {
        const client = document.getElementById('c_name').value || "Client Comptant";
        let totalVente = 0;
        let totalProfit = 0;
        let nomsProduits = [];

        // Mise à jour du stock et calculs
        cart.forEach(item => {
            const prod = db.inventory.find(p => p.id == item.id);
            prod.qty -= item.qty;
            totalVente += item.subtotal;
            totalProfit += (item.price - item.cost) * item.qty;
            nomsProduits.push(`${item.name} (x${item.qty})`);
        });

        // Enregistrement DB locale
        const saleRecord = {
            client,
            items: nomsProduits.join(", "),
            total: totalVente,
            profit: totalProfit,
            date: new Date().toLocaleDateString()
        };
        
        db.sales.push(saleRecord);
        db.totalProfit += totalProfit;
        save();

        // Générer le PDF Multi-lignes
        generateMultiPDF(client, cart, totalVente);

        // Synchro Cloud (On envoie la liste des produits en un seul bloc texte)
        syncToCloud(nomsProduits.join(", "), totalVente);

        // Reset
        cart = [];
        document.getElementById('c_name').value = "";
        renderCart();
        init();
        showPage('home');
    }

    // --- PDF POUR PLUSIEURS ARTICLES ---
    function generateMultiPDF(client, items, total) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        if(db.profile.logo) doc.addImage(db.profile.logo, 'PNG', 15, 10, 20, 20);
        doc.setFontSize(18); doc.text(db.profile.biz.toUpperCase(), 40, 20);
        doc.setFontSize(8); doc.text(`${db.profile.adr} | WhatsApp: ${db.profile.tel}`, 40, 26);
        
        doc.setFontSize(10);
        doc.text(`FACTURE N°: ${Date.now().toString().slice(-6)}`, 15, 45);
        doc.text(`Client: ${client}`, 15, 50);
        doc.text(`Date: ${new Date().toLocaleString()}`, 140, 50);

        const tableBody = items.map(i => [i.name, i.qty, i.price, i.subtotal]);
        
        doc.autoTable({
            startY: 55,
            head: [['Produit', 'Qté', 'Prix Unitaire', 'Sous-total']],
            body: tableBody,
            theme: 'striped',
            headStyles: { fillColor: [37, 99, 235] },
            foot: [['', '', 'TOTAL GLOBAL', total + " " + db.profile.cur]],
            footStyles: { fillColor: [241, 245, 249], textColor: [0, 0, 0], fontStyle: 'bold' }
        });

        doc.setFontSize(8);
        doc.text("Merci de votre fidélité !", 105, doc.lastAutoTable.finalY + 20, {align: 'center'});
        
        doc.save(`Facture_${client}_${Date.now().toString().slice(-4)}.pdf`);
    }
</script>
