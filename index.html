<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComptaPro Simple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f3f4f6; }
        .btn { padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; color: white; margin-top: 10px; }
        .input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 8px; }
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid #ddd; }
        .page { display: none; padding: 20px; }
        .active { display: block; }
    </style>
</head>
<body>

    <div id="page-config" class="page active">
        <h2 class="text-xl font-bold mb-4">Connexion Cloud</h2>
        <input id="url" type="text" placeholder="URL NocoDB (Projet)" class="input">
        <button onclick="saveConfig()" class="btn bg-blue-600">DÉMARRER</button>
    </div>

    <div id="page-vente" class="page">
        <h2 class="text-xl font-bold mb-4">Nouvelle Vente</h2>
        <input id="cli" type="text" placeholder="Nom du Client" class="input">
        <select id="prod-select" class="input"></select>
        <input id="qte" type="number" value="1" class="input">
        <button onclick="vendre()" class="btn bg-green-600">VENDRE & PDF</button>
    </div>

    <div id="page-stock" class="page">
        <h2 class="text-xl font-bold mb-4">Gestion Stock</h2>
        <input id="p_nom" type="text" placeholder="Produit" class="input">
        <input id="p_prix" type="number" placeholder="Prix" class="input">
        <input id="p_stock" type="number" placeholder="Quantité" class="input">
        <button onclick="ajouterStock()" class="btn bg-blue-600">AJOUTER AU CLOUD</button>
        <div id="liste-stock" class="mt-4"></div>
    </div>

    <div id="page-frais" class="page">
        <h2 class="text-xl font-bold mb-4">Dépenses</h2>
        <input id="f_motif" type="text" placeholder="Motif" class="input">
        <input id="f_montant" type="number" placeholder="Montant" class="input">
        <button onclick="ajouterFrais()" class="btn bg-red-500">ENREGISTRER FRAIS</button>
    </div>

    <nav id="menu" style="display: none;">
        <button onclick="show('page-vente')">Vente</button>
        <button onclick="show('page-stock')">Stock</button>
        <button onclick="show('page-frais')">Frais</button>
    </nav>

    <script>
        const TOKEN = "1WLL5zRuBwK3nLuq4YBNZ8f2KHCXgzdgBXURpOKJ";
        let config = JSON.parse(localStorage.getItem('conf'));

        if(config) show('page-vente');

        function saveConfig() {
            let url = document.getElementById('url').value;
            localStorage.setItem('conf', JSON.stringify({url}));
            location.reload();
        }

        async function api(table, method="GET", body=null) {
            let res = await fetch(`${JSON.parse(localStorage.getItem('conf')).url}/${table}`, {
                method, headers: {'xc-token': TOKEN, 'Content-Type': 'application/json'},
                body: body ? JSON.stringify(body) : null
            });
            return res.json();
        }

        async function show(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'page-vente') loadProds();
            if(id === 'page-stock') listStock();
            document.getElementById('menu').style.display = 'flex';
        }

        async function loadProds() {
            let data = await api('Produits');
            document.getElementById('prod-select').innerHTML = data.list.map(p => `<option value="${p.Prix}">${p.Nom} (${p.Stock})</option>`).join('');
        }

        async function ajouterStock() {
            await api('Produits', 'POST', {
                Nom: document.getElementById('p_nom').value,
                Prix: document.getElementById('p_prix').value,
                Stock: document.getElementById('p_stock').value
            });
            alert("Ajouté !"); listStock();
        }

        async function listStock() {
            let data = await api('Produits');
            document.getElementById('liste-stock').innerHTML = data.list.map(p => `<div class='bg-white p-2 mb-2 rounded'>${p.Nom} - ${p.Stock} en stock</div>`).join('');
        }

        async function ajouterFrais() {
            await api('Frais', 'POST', {
                Motif: document.getElementById('f_motif').value,
                Montant: document.getElementById('f_montant').value
            });
            alert("Frais enregistré !");
        }

        async function vendre() {
            let sel = document.getElementById('prod-select');
            let total = sel.value * document.getElementById('qte').value;
            await api('Ventes', 'POST', { Client: document.getElementById('cli').value, Total: total });
            
            // Générer PDF simple
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF();
            doc.text(`Client: ${document.getElementById('cli').value}`, 10, 10);
            doc.text(`Total: ${total} FCFA`, 10, 20);
            doc.save("Facture.pdf");
            alert("Vendu !");
        }
    </script>
</body>
</html>
