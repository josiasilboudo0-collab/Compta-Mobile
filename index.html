<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComptaPro Fix v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; }
        input, select { border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 10px; }
        .btn { padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; color: white; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="setup-screen" class="fixed inset-0 bg-white z-[100] p-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Configuration Boutique</h2>
        <input type="text" id="setup_biz" placeholder="Nom de ton entreprise">
        <select id="setup_cur">
            <option value="FCFA">FCFA</option>
            <option value="USD">USD ($)</option>
        </select>
        <button onclick="configurer()" class="btn bg-blue-600">DÃ‰MARRER</button>
    </div>

    <header class="p-4 bg-white border-b flex justify-between items-center">
        <h1 id="brand" class="font-bold text-blue-600">ComptaPro</h1>
        <div id="sync-indicator" class="w-3 h-3 rounded-full bg-gray-300"></div>
    </header>

    <main class="p-4">
        <div id="page-home" class="page active">
            <div class="bg-slate-900 p-6 rounded-2xl text-white mb-6">
                <p class="text-xs opacity-60 uppercase">Profit Net Local</p>
                <h2 class="text-3xl font-bold"><span id="display-profit">0</span> <span class="cur"></span></h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="nav('invoice')" class="bg-white p-6 rounded-xl border shadow-sm">ðŸ›’ VENTE</button>
                <button onclick="nav('stock')" class="bg-white p-6 rounded-xl border shadow-sm">ðŸ“¦ STOCK</button>
            </div>
            <button onclick="reinitialiser()" class="mt-10 text-red-500 text-xs text-center w-full uppercase">RÃ©initialiser Localement</button>
        </div>

        <div id="page-invoice" class="page">
            <h2 class="text-xl font-bold mb-4">Faire une vente</h2>
            <div class="bg-white p-4 rounded-xl border">
                <label class="text-xs">Produit :</label>
                <select id="select-prod"></select>
                <label class="text-xs">QuantitÃ© :</label>
                <input type="number" id="sale-qty" value="1">
                <button onclick="validerVente()" class="btn bg-blue-600">VALIDER & CLOUD</button>
            </div>
            <button onclick="nav('home')" class="mt-4 text-gray-500 underline">Retour</button>
        </div>

        <div id="page-stock" class="page">
            <h2 class="text-xl font-bold mb-4">Ajouter au Stock</h2>
            <div class="bg-white p-4 rounded-xl border">
                <input type="text" id="p-name" placeholder="Nom du produit">
                <input type="number" id="p-cost" placeholder="Prix d'achat">
                <input type="number" id="p-price" placeholder="Prix de vente">
                <input type="number" id="p-qty" placeholder="QuantitÃ©">
                <button onclick="ajouterStock()" class="btn bg-emerald-600">AJOUTER</button>
            </div>
            <div id="list-stock" class="mt-4 space-y-2"></div>
            <button onclick="nav('home')" class="mt-4 text-gray-500 underline">Retour</button>
        </div>
    </main>

    <script>
        // CONFIG NOCODB
        const API_URL = "https://nano-bee.pikapod.net/api/v1/db/data/v1/Business_Manager/Ventes_Cloud";
        const TOKEN = "1WLL5zRuBwK3nLuq4YBNZ8f2KHCXgzdgBXURpOKJ";

        let db = JSON.parse(localStorage.getItem('cp_final_save')) || {
            profile: null, inventory: [], totalProfit: 0, uid: Math.floor(Math.random()*9000)
        };

        window.onload = function() {
            if(!db.profile) {
                document.getElementById('setup-screen').classList.remove('hidden');
            } else {
                actualiser();
            }
        };

        function configurer() {
            const biz = document.getElementById('setup_biz').value;
            const cur = document.getElementById('setup_cur').value;
            if(!biz) return alert("Nom requis");
            db.profile = { biz, cur };
            sauvegarder();
            document.getElementById('setup-screen').classList.add('hidden');
            actualiser();
        }

        function ajouterStock() {
            const name = document.getElementById('p-name').value;
            const cost = parseInt(document.getElementById('p-cost').value);
            const price = parseInt(document.getElementById('p-price').value);
            const qty = parseInt(document.getElementById('p-qty').value);

            if(!name || isNaN(cost)) return alert("Remplissez tout");

            db.inventory.push({ id: Date.now(), name, cost, price, qty });
            sauvegarder();
            actualiser();
            alert("Produit ajoutÃ© !");
        }

        async function validerVente() {
            const pId = document.getElementById('select-prod').value;
            const qty = parseInt(document.getElementById('sale-qty').value);
            const prod = db.inventory.find(p => p.id == pId);

            if(!prod || isNaN(qty)) return alert("SÃ©lectionnez un produit");

            const total = prod.price * qty;
            const profit = (prod.price - prod.cost) * qty;

            // ENVOI CLOUD
            document.getElementById('sync-indicator').className = "w-3 h-3 rounded-full bg-orange-500 animate-pulse";
            
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "xc-token": TOKEN },
                    body: JSON.stringify({
                        "Boutique": db.profile.biz,
                        "Client_UID": String(db.uid),
                        "Produit_Vendu": prod.name + " x" + qty,
                        "Prix_Total": total,
                        "Date_Vente": new Date().toISOString()
                    })
                });
                
                if(res.ok) {
                    document.getElementById('sync-indicator').className = "w-3 h-3 rounded-full bg-green-500";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('sync-indicator').className = "w-3 h-3 rounded-full bg-red-500";
            }

            // MISE A JOUR LOCALE
            prod.qty -= qty;
            db.totalProfit += profit;
            sauvegarder();
            actualiser();
            nav('home');
            alert("Vente validÃ©e !");
        }

        function actualiser() {
            document.getElementById('brand').innerText = db.profile.biz;
            document.getElementById('display-profit').innerText = db.totalProfit.toLocaleString();
            document.querySelectorAll('.cur').forEach(el => el.innerText = db.profile.cur);
            
            // Liste stock
            document.getElementById('list-stock').innerHTML = db.inventory.map(p => `
                <div class="bg-white p-3 rounded-lg border flex justify-between">
                    <span>${p.name}</span>
                    <span class="font-bold">${p.qty}</span>
                </div>
            `).join('');

            // Select vente
            document.getElementById('select-prod').innerHTML = db.inventory.map(p => `
                <option value="${p.id}">${p.name} (${p.qty})</option>
            `).join('');
            
            lucide.createIcons();
        }

        function nav(p) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
        }

        function sauvegarder() {
            localStorage.setItem('cp_final_save', JSON.stringify(db));
        }

        function reinitialiser() {
            if(confirm("Effacer le profit et le stock local ?")) {
                db.inventory = [];
                db.totalProfit = 0;
                sauvegarder();
                actualiser();
            }
        }
    </script>
</body>
</html>
