<script>
    lucide.createIcons();
    // On ajoute 'trialStarted' dans la base de données
    let db = JSON.parse(localStorage.getItem('cp_stock_db')) || { profile: null, inventory: [], sales: [], totalProfit: 0, trialStarted: null };
    let logoBase64 = db.profile ? db.profile.logo : "";

    // FONCTION DE VÉRIFICATION DU BLOCAGE
    function checkTrialStatus() {
        if (!db.profile) return; // Pas encore de profil, on laisse le setup s'afficher

        const TEN_DAYS_IN_MS = 10 * 24 * 60 * 60 * 1000;
        const now = Date.now();
        const expiryDate = db.trialStarted + TEN_DAYS_IN_MS;

        if (now > expiryDate) {
            // BLOCAGE : On remplace le contenu du body par l'écran Premium
            document.body.innerHTML = `
                <div class="fixed inset-0 bg-white z-[9999] p-8 flex flex-col items-center justify-center text-center">
                    <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="crown" class="text-amber-500 w-10 h-10"></i>
                    </div>
                    <h2 class="text-3xl font-black mb-4">Essai Terminé</h2>
                    <p class="text-slate-500 mb-8 text-sm">Vos 10 jours d'essai gratuit sont terminés. Pour continuer à gérer votre stock et accéder à vos données, activez votre abonnement.</p>
                    <div class="bg-slate-50 p-6 rounded-[2rem] w-full mb-8 border border-amber-100">
                        <p class="text-4xl font-black text-slate-900">3 000F <span class="text-sm font-normal text-slate-400">/ mois</span></p>
                    </div>
                    <a href="https://me.fedapay.com/sF5bKiUt" target="_blank" class="btn-p w-full bg-amber-500 shadow-xl shadow-amber-200 text-center flex items-center justify-center">
                        S'ABONNER MAINTENANT
                    </a>
                    <p class="mt-8 text-[10px] text-slate-400 uppercase font-bold tracking-widest">Paiement sécurisé via FedaPay</p>
                </div>
            `;
            lucide.createIcons();
            return false;
        }
        return true;
    }

    // On affiche le setup si pas de profil, sinon on lance l'init
    if(!db.profile) {
        document.getElementById('setup-screen').classList.remove('hidden');
    } else {
        if (checkTrialStatus()) {
            init();
        }
    }

    function previewLogo(e) {
        const reader = new FileReader();
        reader.onload = () => { 
            logoBase64 = reader.result;
            document.getElementById('logoPreview').src = reader.result;
            document.getElementById('logoPreview').classList.remove('hidden');
            document.getElementById('logoIcon').classList.add('hidden');
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function saveProfile() {
        db.profile = { 
            biz: document.getElementById('u_biz').value, 
            fname: document.getElementById('u_fname').value,
            lname: document.getElementById('u_lname').value,
            cur: document.getElementById('u_cur').value,
            email: document.getElementById('u_email').value,
            phone: document.getElementById('u_phone').value,
            country: document.getElementById('u_country').value,
            logo: logoBase64
        };
        // ON ENREGISTRE LA DATE DE DÉBUT ICI
        db.trialStarted = Date.now(); 
        
        localStorage.setItem('cp_stock_db', JSON.stringify(db)); 
        location.reload();
    }

    // ... (Le reste de tes fonctions : updateSettings, init, addProduct, processSale, etc. restent identiques)
    // Assure-toi juste que l'appel à checkTrialStatus() est présent au début de tes fonctions importantes si tu veux une sécurité maximale.

    function init() {
        document.getElementById('headBiz').innerText = db.profile.biz;
        if(db.profile.logo) { document.getElementById('headLogo').src = db.profile.logo; document.getElementById('headLogo').classList.remove('hidden'); }
        document.querySelectorAll('.cur').forEach(e => e.innerText = db.profile.cur);
        
        document.getElementById('set_biz').value = db.profile.biz;
        document.getElementById('set_fname').value = db.profile.fname;
        document.getElementById('set_lname').value = db.profile.lname;
        document.getElementById('set_email').value = db.profile.email;
        document.getElementById('set_phone').value = db.profile.phone;
        document.getElementById('set_country').value = db.profile.country;

        renderStock(); renderHome(); populateProductSelect();
    }
    
    // N'oublie pas de copier toutes tes autres fonctions (save, addProduct, processSale, etc.) en dessous
</script>
